name: TUO-Dev-Deploy

on:
  workflow_dispatch:
  workflow_run:
    branches: [dev]
    workflows: [Build-Test]
    types:
      - completed

env:
  CUO_OUTPUT_PATH: 'build/dist'
  CUO_PROJECT_PATH: "src/ClassicUO.Client/ClassicUO.Client.csproj"
  TAG_NAME: "TazUO-BleedingEdge"
  RELEASE_LINK: "https://github.com/bittiez/TazUO/releases/tag/TazUO-BleedingEdge"
  UPLOAD_BODY: |
    These are built automatically on the dev branch.
    These may include features that are still being worked on/not complete.
    These are modern dotnet builds of TazUO, they do not support plugins. For plugin support see the Legacy releases.
  UPLOAD_MAKELATEST: false
  UPLOAD_PRERELEASE: true

  DOTNET_NOLOGO: false
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  NUGET_XMLDOC_MODE: skip

jobs:
  build:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-arm64
    outputs:
      rid: ${{ matrix.rid }}
      release_notes: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'dev'

      - name: Get submodules
        run: |
          git config --global url."https://".insteadOf git://
          git submodule update --init --recursive

      - name: Extract Version
        if: ${{ strategy.job-index == 0 }}
        shell: bash
        id: version
        run: |
          export LC_ALL=C.UTF-8
          VERSION=$(grep -oP '<AssemblyVersion>\K\d+\.\d+\.\d+' src/ClassicUO.Client/ClassicUO.Client.csproj)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10

      - name: Build executable
        run: dotnet publish ${{ env.CUO_PROJECT_PATH }} -c Release -o ${{ env.CUO_OUTPUT_PATH }} -r ${{ matrix.rid }}

      - name: Zip all builds
        shell: bash
        run: |
          mkdir -p flat

          # Copy files excluding *.dSYM (folders or files), preserving subfolders
          for d in "${{ env.CUO_OUTPUT_PATH }}" "${{ env.CUO_OUTPUT_PATH }}-Lib"; do
            [ -d "$d" ] || continue

            find "$d" \( -name '*.dSYM' -o -name '*.dSYM/' \) -prune -o -type f -print |
            while IFS= read -r file; do
              dest="flat/${file#$d/}"
              mkdir -p "$(dirname "$dest")"
              cp "$file" "$dest"
            done
          done

          cd flat

          echo "Runner OS: $RUNNER_OS"

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # Use PowerShell Compress-Archive for Windows
            pwsh -Command "Compress-Archive -Path * -DestinationPath ../${{ matrix.rid }}.zip -Force"
          else
            # Linux and macOS
            zip -r ../${{ matrix.rid }}.zip .
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}.zip
          path: ${{ matrix.rid }}.zip
          retention-days: 3

      - name: Create macOS .app bundle
        if: startsWith(matrix.rid, 'osx-')
        shell: bash
        run: |
          VERSION=$(sed -n 's/.*<AssemblyVersion>\([0-9.]*\)<.*/\1/p' src/ClassicUO.Client/ClassicUO.Client.csproj)
          APP="TazUO.app"
          CONTENTS="$APP/Contents"
          MACOS="$CONTENTS/MacOS"
          RESOURCES="$CONTENTS/Resources"

          mkdir -p "$MACOS" "$RESOURCES"

          # Copy all published files into MacOS/ (from the flat dir used for the zip)
          cp -a flat/. "$MACOS/"

          # Generate icon
          brew install imagemagick
          magick src/ClassicUO.Client/cuoicon.ico -flatten largest.png
          mkdir -p icon.iconset
          for size in 16 32 64 128 256 512; do
            sips -z $size $size largest.png --out icon.iconset/icon_${size}x${size}.png
          done
          for size in 16 32 128 256; do
            double=$((size * 2))
            cp icon.iconset/icon_${double}x${double}.png icon.iconset/icon_${size}x${size}@2x.png
          done
          sips -z 1024 1024 largest.png --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o "$RESOURCES/icon.icns"

          # Info.plist
          cat > "$CONTENTS/Info.plist" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>TazUO</string>
            <key>CFBundleIdentifier</key>
            <string>com.crameep.tazuo</string>
            <key>CFBundleName</key>
            <string>TazUO</string>
            <key>CFBundleIconFile</key>
            <string>icon</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          PLIST

          # PkgInfo
          echo -n "APPL????" > "$CONTENTS/PkgInfo"

          # Ad-hoc codesign
          codesign --force --deep --sign - "$APP"

          # Zip the .app bundle
          zip -r -y "${{ matrix.rid }}.app.zip" "$APP"

      - name: Upload macOS .app artifact
        if: startsWith(matrix.rid, 'osx-')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}.app.zip
          path: ${{ matrix.rid }}.app.zip
          retention-days: 3

      - name: Get last release commit
        if: ${{ strategy.job-index == 0 }}
        shell: bash
        id: last_release
        run: |
          if git rev-parse --verify "${{ env.TAG_NAME }}" >/dev/null 2>&1; then
            LAST_COMMIT=$(git rev-parse "${{ env.TAG_NAME }}")
            echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV
            echo "Last release commit: $LAST_COMMIT"
          else
            echo "No previous release found."
            echo "LAST_COMMIT=" >> $GITHUB_ENV
          fi

      - name: Generate release notes
        if: ${{ strategy.job-index == 0 }}
        shell: bash
        id: release_notes
        run: |
          if [ -z "$LAST_COMMIT" ]; then
            echo "No previous release found. Listing 10 latest commits."
            RELEASE_NOTES=$(git log -10 --pretty=format:%B)
          else
            echo "Generating release notes from commit $LAST_COMMIT to HEAD."
            RELEASE_NOTES=$(git log ${LAST_COMMIT}..HEAD --pretty=format:%B)
          fi

          printf "RELEASE_NOTES<<EOF\n%s\nEOF\n" "$RELEASE_NOTES" >> $GITHUB_OUTPUT

      - name: Echo release notes
        if: ${{ strategy.job-index == 0 }}
        shell: bash
        run: echo "${{ steps.release_notes.outputs.RELEASE_NOTES }}"

      - name: Create tag
        continue-on-error: true
        if: ${{ strategy.job-index == 0 }}
        run: |
          git tag v${{ env.VERSION }}
          git push origin v${{ env.VERSION }}


  upload:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: 'dev'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-zips

      - name: Flatten artifact structure
        run: |
          mkdir -p zips
          find all-zips -name "*.zip" -type f -exec mv {} zips/ \;

      - name: List downloaded zips
        run: ls -R zips

      - name: Remove old Release
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete ${{ env.TAG_NAME }} --yes --cleanup-tag || true

      - name: Upload all zips to release
        uses: ncipollo/release-action@v1.20.0
        with:
          artifacts: "zips/*.zip"
          name: 'Development v${{ needs.build.outputs.version }}'
          body: |
            ${{ env.UPLOAD_BODY }}

            # Release notes
            ${{ needs.build.outputs.release_notes }}
          makeLatest: ${{ env.UPLOAD_MAKELATEST }}
          allowUpdates: true
          prerelease: ${{ env.UPLOAD_PRERELEASE }}
          tag: ${{ env.TAG_NAME }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Discord Github Updates
        uses: tsickert/discord-webhook@v7.0.0
        continue-on-error: true
        with:
          webhook-url: ${{ secrets.DISCORDWEBHOOK }}
          content: |
            # v${{ needs.build.outputs.version }} is available for [${{ env.TAG_NAME }}].

            [Download here](<${{ env.RELEASE_LINK }}>)
            Or use the [launcher](<https://github.com/bittiez/TUO-Launcher/releases/latest>)

            # Release notes
            `These are automatically generated`
            ${{ needs.build.outputs.release_notes }}

      - name: Trigger docs repository build
        uses: peter-evans/repository-dispatch@v3
        continue-on-error: true
        with:
          token: ${{ secrets.BUILD_DOCS}}
          repository: PlayTazUO/website
          event-type: build-docs
          client-payload: |
            {
              "source_repo": "PlayTazUO/TazUO",
              "source_branch": "dev",
              "wiki_repo": "PlayTazUO/TazUO.wiki",
              "wiki_branch": "main"
            }
